<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Festa Musical Sincronizada</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #121218;
            --surface-color: #1A1A22;
            --primary-color: #9f33ff;
            --secondary-color: #00e5ff;
            --text-color: #E1E1E6;
            --text-muted-color: #A8A8B3;
            --success-color: #00e5ff;
            --danger-color: #ff4757;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: auto;
        }

        /* --- Tela de Entrada --- */
        #entry-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            animation: fadeIn 0.5s ease-in-out;
        }

        .entry-title {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--secondary-color);
        }

        .entry-box {
            background-color: var(--surface-color);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }

        .entry-box h2 {
            text-align: center;
            color: var(--text-color);
            font-weight: 600;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-field {
            background-color: var(--background-color);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.8rem 1rem;
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-color);
        }

        .btn {
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(159, 51, 255, 0.4);
        }

        /* --- Tela da Festa --- */
        #party-screen {
            display: none;
            flex-direction: column;
            gap: 1.5rem;
            height: 95vh;
            animation: fadeIn 0.5s ease-in-out;
        }

        .party-header {
            background-color: var(--surface-color);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .header-info .credits {
            font-size: 0.8rem;
            color: var(--text-muted-color);
        }

        .room-key-display {
            font-size: 1rem;
            font-weight: 600;
        }

        .room-key-display span {
            font-family: monospace;
            background-color: var(--background-color);
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            color: var(--secondary-color);
            margin-left: 0.5rem;
        }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .party-main {
            display: grid;
            grid-template-columns: 250px 1fr 350px;
            gap: 1.5rem;
            flex-grow: 1;
            min-height: 0;
        }

        .sidebar {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }
        
        .right-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-height: 0;
        }

        .sidebar h3 {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .list-item {
            padding: 0.5rem;
            background-color: var(--background-color);
            border-radius: 6px;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .list-item .requested-by, .list-item .request-user {
            font-size: 0.8rem;
            color: var(--text-muted-color);
            display: block;
            margin-top: 0.2rem;
        }
        
        .dj .participant-name::after { content: 'ðŸ‘‘'; margin-left: 0.5rem; }
        
        .player-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-width: 0;
        }

        #player-container {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: black;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #player-placeholder {
            color: var(--text-muted-color);
            font-size: 1.2rem;
            text-align: center;
            padding: 1rem;
        }

        #player { width: 100%; height: 100%; }

        .controls { display: flex; flex-direction: column; gap: 1rem; }
        .controls-row { display: flex; gap: 1rem; }
        .controls .input-field { flex-grow: 1; }

        .request-item { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
        .request-info { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .request-actions { display: flex; gap: 0.5rem; }
        .request-actions .btn { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        .btn-accept { background-color: var(--success-color); color: var(--background-color); }
        .btn-decline { background-color: var(--danger-color); color: white; }
        .btn-done { background-color: var(--primary-color); color: white; }

        /* --- Chat --- */
        #chat-section {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .chat-message {
            margin-bottom: 0.5rem;
        }
        .chat-message .username {
            font-weight: bold;
            color: var(--secondary-color);
        }
        .chat-message .text {
            margin-left: 0.5rem;
        }
        #chat-input { flex-grow: 1; }

        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: var(--primary-color); color: white; padding: 1rem 1.5rem;
            border-radius: 8px; z-index: 1000; opacity: 0;
            transition: opacity 0.3s, transform 0.3s; pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translate(-50%, -10px); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Responsividade --- */
        @media (max-width: 1200px) {
            .party-main { grid-template-columns: 1fr 300px; }
            #participants-section { grid-column: 2; grid-row: 1; }
            .right-sidebar { grid-column: 2; grid-row: 2; }
            .player-section { grid-column: 1; grid-row: 1 / span 2; }
        }
        @media (max-width: 900px) {
            .party-main { display: flex; flex-direction: column; }
            .sidebar, .right-sidebar { width: 100%; max-height: 250px; }
            #party-screen { height: auto; }
        }
        @media (max-width: 600px) {
            .entry-title { font-size: 2rem; }
            .party-header { flex-direction: column; gap: 1rem; align-items: flex-start; }
            .controls-row { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Tela de Entrada -->
        <div id="entry-screen">
            <h1 class="entry-title">Festa Musical Sincronizada</h1>
            <div class="entry-box">
                <h2>Criar uma Sala</h2>
                <div class="input-group">
                    <input type="text" id="create-username" class="input-field" placeholder="Seu nome de usuÃ¡rio">
                </div>
                <button id="create-room-btn" class="btn btn-primary">Criar Sala</button>
            </div>
            <div class="entry-box">
                <h2>Entrar em uma Sala</h2>
                <div class="input-group">
                    <input type="text" id="join-username" class="input-field" placeholder="Seu nome de usuÃ¡rio">
                </div>
                <div class="input-group">
                    <input type="text" id="room-key-input" class="input-field" placeholder="Chave da sala">
                </div>
                <button id="join-room-btn" class="btn btn-primary">Entrar na Sala</button>
            </div>
        </div>

        <!-- Tela da Festa -->
        <div id="party-screen">
            <header class="party-header">
                <div class="header-info">
                    <div class="room-key-display">Sala: <span id="room-key-display"></span></div>
                    <div class="credits">Desenvolvido por Higor Matheus</div>
                </div>
                <button id="copy-link-btn" class="btn btn-secondary">Copiar Link da Sala</button>
            </header>

            <main class="party-main">
                <aside id="participants-section" class="sidebar">
                    <h3>Participantes</h3>
                    <ul id="participants-list" class="list"></ul>
                </aside>

                <section class="player-section">
                    <div id="player-container">
                        <div id="player-placeholder">Aguardando mÃºsica...</div>
                        <div id="player"></div>
                    </div>
                    
                    <div id="dj-controls" class="controls">
                         <div class="controls-row">
                            <input type="text" id="dj-video-url-input" class="input-field" placeholder="Cole um link de vÃ­deo para tocar agora">
                            <button id="play-video-btn" class="btn btn-primary">Tocar</button>
                        </div>
                        <div class="controls-row">
                            <input type="text" id="dj-playlist-url-input" class="input-field" placeholder="Cole um link de playlist para adicionar Ã  fila">
                            <button id="add-playlist-btn" class="btn btn-secondary">Adicionar Playlist</button>
                        </div>
                    </div>

                    <div id="user-controls" class="controls">
                        <div class="controls-row">
                            <input type="text" id="user-video-url-input" class="input-field" placeholder="Cole o link da mÃºsica aqui...">
                            <button id="request-song-btn" class="btn btn-secondary">Pedir com Link</button>
                        </div>
                         <div class="controls-row">
                            <input type="text" id="user-text-request-input" class="input-field" placeholder="...ou peÃ§a pelo nome da mÃºsica">
                            <button id="text-request-btn" class="btn btn-secondary">Pedir por Texto</button>
                        </div>
                    </div>
                </section>

                <aside class="right-sidebar">
                    <div id="queue-section" class="sidebar">
                        <h3>Fila de MÃºsicas</h3>
                        <ul id="queue-list" class="list"></ul>
                        <div id="dj-requests-section">
                            <h3>Pedidos com Link</h3>
                            <ul id="link-requests-list" class="list"></ul>
                            <h3 style="margin-top: 1rem;">Pedidos por Texto</h3>
                            <ul id="text-requests-list" class="list"></ul>
                        </div>
                    </div>
                    <div id="chat-section" class="sidebar">
                        <h3>Chat da Sala</h3>
                        <ul id="chat-messages" class="list"></ul>
                        <div class="controls-row">
                            <input type="text" id="chat-input" class="input-field" placeholder="Digite sua mensagem...">
                            <button id="send-chat-btn" class="btn btn-primary">Enviar</button>
                        </div>
                    </div>
                </aside>
            </main>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- ConfiguraÃ§Ã£o do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyA1IEE4mLnTv2RPe4SA59qulMi0ztYucgU",
            authDomain: "music-synchronizer-ip.firebaseapp.com",
            databaseURL: "https://music-synchronizer-ip-default-rtdb.firebaseio.com",
            projectId: "music-synchronizer-ip",
            storageBucket: "music-synchronizer-ip.appspot.com",
            messagingSenderId: "479191802300",
            appId: "1:479191802300:web:77729d3648f8f2a3400bb9"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- VariÃ¡veis Globais ---
        let player, isYouTubeApiReady = false, currentRoomKey = null, currentUserId = null;
        let currentUsername = null, isDj = false, serverTimeOffset = 0, syncInterval;
        let lastKnownPlaybackState = {};

        // --- Elementos do DOM ---
        const entryScreen = document.getElementById('entry-screen');
        const partyScreen = document.getElementById('party-screen');
        const createUsernameInput = document.getElementById('create-username');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinUsernameInput = document.getElementById('join-username');
        const roomKeyInput = document.getElementById('room-key-input');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const roomKeyDisplay = document.getElementById('room-key-display');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const participantsList = document.getElementById('participants-list');
        const djControls = document.getElementById('dj-controls');
        const userControls = document.getElementById('user-controls');
        const djVideoUrlInput = document.getElementById('dj-video-url-input');
        const userVideoUrlInput = document.getElementById('user-video-url-input');
        const userTextRequestInput = document.getElementById('user-text-request-input');
        const djPlaylistUrlInput = document.getElementById('dj-playlist-url-input');
        const playVideoBtn = document.getElementById('play-video-btn');
        const requestSongBtn = document.getElementById('request-song-btn');
        const textRequestBtn = document.getElementById('text-request-btn');
        const addPlaylistBtn = document.getElementById('add-playlist-btn');
        const playerPlaceholder = document.getElementById('player-placeholder');
        const queueList = document.getElementById('queue-list');
        const djRequestsSection = document.getElementById('dj-requests-section');
        const linkRequestsList = document.getElementById('link-requests-list');
        const textRequestsList = document.getElementById('text-requests-list');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');

        // --- FunÃ§Ãµes Auxiliares ---
        const generateRoomKey = () => Math.random().toString(36).substring(2, 8).toUpperCase();
        const showToast = (message) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };
        const getYouTubeVideoId = (url) => {
            if (!url) return null;
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname === 'youtu.be') return urlObj.pathname.slice(1).split('?')[0];
                if (urlObj.hostname.includes('youtube.com')) return urlObj.searchParams.get('v');
            } catch (e) { return null; }
            return null;
        };
        const getYouTubePlaylistId = (url) => {
            if (!url) return null;
            try { return new URL(url).searchParams.get('list'); } catch(e) { return null; }
        };
        const getYouTubeVideoTitle = async (videoId) => {
            try {
                const res = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
                return res.ok ? (await res.json()).title || videoId : videoId;
            } catch (error) { return videoId; }
        };
        const fetchPlaylistItems = async (playlistId) => {
            try {
                const res = await fetch(`https://yt-playlist-scraper.vercel.app/api/playlist/${playlistId}`);
                if (!res.ok) throw new Error('API falhou');
                const data = await res.json();
                return data.videos.map(v => ({ videoId: v.id, title: v.title }));
            } catch (error) {
                showToast("Erro ao carregar a playlist.");
                return [];
            }
        };
        const getServerTime = () => Date.now() + serverTimeOffset;

        // --- LÃ³gica da AplicaÃ§Ã£o ---
        window.onload = () => {
            currentUserId = `user-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            database.ref('.info/serverTimeOffset').on('value', s => serverTimeOffset = s.val());
        };

        createRoomBtn.addEventListener('click', () => {
            currentUsername = createUsernameInput.value.trim();
            if (!currentUsername) return showToast("Por favor, insira um nome de usuÃ¡rio.");
            isDj = true;
            currentRoomKey = generateRoomKey();
            database.ref(`rooms/${currentRoomKey}`).set({
                dj: currentUserId,
                playback: { videoId: null, isPlaying: false, videoTime: 0, timestamp: 0 },
                createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => joinRoom(currentRoomKey));
        });

        joinRoomBtn.addEventListener('click', () => {
            currentUsername = joinUsernameInput.value.trim();
            const roomKey = roomKeyInput.value.trim().toUpperCase();
            if (!currentUsername || !roomKey) return showToast("Por favor, preencha todos os campos.");
            database.ref(`rooms/${roomKey}`).once('value', s => {
                if (s.exists()) { currentRoomKey = roomKey; joinRoom(currentRoomKey); }
                else { showToast("Sala nÃ£o encontrada."); }
            });
        });

        function joinRoom(roomKey) {
            const userRef = database.ref(`rooms/${roomKey}/participants/${currentUserId}`);
            userRef.set({ username: currentUsername, isDj: isDj });
            userRef.onDisconnect().remove();
            switchToPartyView(roomKey);
            listenToRoomUpdates(roomKey);
        }

        function switchToPartyView(roomKey) {
            entryScreen.style.display = 'none';
            partyScreen.style.display = 'flex';
            roomKeyDisplay.textContent = roomKey;
            djControls.style.display = isDj ? 'flex' : 'none';
            userControls.style.display = isDj ? 'none' : 'flex';
            djRequestsSection.style.display = isDj ? 'block' : 'none';
        }

        function listenToRoomUpdates(roomKey) {
            database.ref(`rooms/${roomKey}/participants`).on('value', s => updateParticipantsList(s.val()));
            database.ref(`rooms/${roomKey}/playback`).on('value', s => handlePlaybackChange(s.val()));
            database.ref(`rooms/${roomKey}/queue`).on('value', s => updateQueueList(s.val()));
            database.ref(`rooms/${roomKey}/chat`).on('child_added', s => updateChat(s.val()));
            if (isDj) {
                database.ref(`rooms/${roomKey}/linkRequests`).on('value', s => updateLinkRequestsList(s.val()));
                database.ref(`rooms/${roomKey}/textRequests`).on('value', s => updateTextRequestsList(s.val()));
            }
        }
        
        const updateParticipantsList = (p) => {
            participantsList.innerHTML = '';
            if (!p) return;
            Object.values(p).forEach(user => {
                const li = document.createElement('li');
                li.className = `list-item ${user.isDj ? 'dj' : ''}`;
                li.innerHTML = `<span class="participant-name">${user.username}</span>`;
                participantsList.appendChild(li);
            });
        };

        const updateQueueList = (q) => {
            queueList.innerHTML = '';
            if (!q) return;
            Object.values(q).forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.title = item.title || item.videoId;
                li.innerHTML = `${item.title || item.videoId}<span class="requested-by">por ${item.requestedBy}</span>`;
                queueList.appendChild(li);
            });
        };

        const updateLinkRequestsList = (reqs) => {
            linkRequestsList.innerHTML = '';
            if (!reqs) return;
            Object.entries(reqs).forEach(([key, req]) => {
                const li = document.createElement('li');
                li.className = 'list-item request-item';
                li.innerHTML = `<div class="request-info" title="${req.title || req.videoId}"><span class="request-title">${req.title || req.videoId}</span><span class="request-user">por ${req.username}</span></div><div class="request-actions"><button class="btn btn-accept" data-req-key="${key}">Aceitar</button><button class="btn btn-decline" data-req-key="${key}">Recusar</button></div>`;
                linkRequestsList.appendChild(li);
            });
        };

        const updateTextRequestsList = (reqs) => {
            textRequestsList.innerHTML = '';
            if (!reqs) return;
            Object.entries(reqs).forEach(([key, req]) => {
                const li = document.createElement('li');
                li.className = 'list-item request-item';
                li.innerHTML = `<div class="request-info" title="${req.text}"><span class="request-title">${req.text}</span><span class="request-user">por ${req.username}</span></div><div class="request-actions"><button class="btn btn-done" data-req-key="${key}">Concluir</button></div>`;
                textRequestsList.appendChild(li);
            });
        };

        const updateChat = (msg) => {
            const li = document.createElement('li');
            li.className = 'list-item chat-message';
            li.innerHTML = `<span class="username">${msg.username}:</span><span class="text">${msg.text}</span>`;
            chatMessages.appendChild(li);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        linkRequestsList.addEventListener('click', e => {
            if (!isDj) return;
            const key = e.target.dataset.reqKey;
            if (!key) return;
            const ref = database.ref(`rooms/${currentRoomKey}/linkRequests/${key}`);
            if (e.target.classList.contains('btn-accept')) {
                ref.once('value', s => {
                    const req = s.val();
                    if (req) database.ref(`rooms/${currentRoomKey}/queue`).push({ videoId: req.videoId, title: req.title, requestedBy: req.username });
                });
            }
            ref.remove();
        });

        textRequestsList.addEventListener('click', e => {
            if (!isDj || !e.target.classList.contains('btn-done')) return;
            const key = e.target.dataset.reqKey;
            if (key) database.ref(`rooms/${currentRoomKey}/textRequests/${key}`).remove();
        });

        copyLinkBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(`${location.href.split('?')[0]}?room=${currentRoomKey}`).then(() => showToast("Link da sala copiado!"));
        });

        const urlParams = new URLSearchParams(location.search);
        const roomFromUrl = urlParams.get('room');
        if (roomFromUrl) roomKeyInput.value = roomFromUrl;
        
        onYouTubeIframeAPIReady = () => isYouTubeApiReady = true;

        playVideoBtn.addEventListener('click', async () => {
            if (!isDj) return;
            const videoId = getYouTubeVideoId(djVideoUrlInput.value.trim());
            if (!videoId) return showToast("URL do YouTube invÃ¡lida.");
            const title = await getYouTubeVideoTitle(videoId);
            djVideoUrlInput.value = '';
            database.ref(`rooms/${currentRoomKey}/playback`).set({ videoId, title, isPlaying: true, videoTime: 0, timestamp: firebase.database.ServerValue.TIMESTAMP });
        });

        addPlaylistBtn.addEventListener('click', async () => {
            if (!isDj) return;
            const playlistId = getYouTubePlaylistId(djPlaylistUrlInput.value.trim());
            if (!playlistId) return showToast("URL de playlist invÃ¡lida.");
            showToast("Carregando playlist...");
            const items = await fetchPlaylistItems(playlistId);
            djPlaylistUrlInput.value = '';
            if (items.length > 0) {
                const queueRef = database.ref(`rooms/${currentRoomKey}/queue`);
                const updates = {};
                items.forEach(item => {
                    const newKey = queueRef.push().key;
                    updates[newKey] = { videoId: item.videoId, title: item.title, requestedBy: currentUsername };
                });
                queueRef.update(updates);
                showToast(`${items.length} mÃºsicas adicionadas Ã  fila!`);
            }
        });

        requestSongBtn.addEventListener('click', async () => {
            const videoId = getYouTubeVideoId(userVideoUrlInput.value.trim());
            if (!videoId) return showToast("URL do YouTube invÃ¡lida.");
            const title = await getYouTubeVideoTitle(videoId);
            userVideoUrlInput.value = '';
            database.ref(`rooms/${currentRoomKey}/linkRequests`).push({ videoId, title, userId: currentUserId, username: currentUsername });
            showToast("Seu pedido com link foi enviado ao DJ!");
        });

        textRequestBtn.addEventListener('click', () => {
            const text = userTextRequestInput.value.trim();
            if (!text) return showToast("Digite o nome de uma mÃºsica.");
            userTextRequestInput.value = '';
            database.ref(`rooms/${currentRoomKey}/textRequests`).push({ text, userId: currentUserId, username: currentUsername });
            showToast("Seu pedido por texto foi enviado ao DJ!");
        });

        sendChatBtn.addEventListener('click', () => {
            const text = chatInput.value.trim();
            if (!text) return;
            chatInput.value = '';
            database.ref(`rooms/${currentRoomKey}/chat`).push({ text, username: currentUsername, timestamp: firebase.database.ServerValue.TIMESTAMP });
        });
        chatInput.addEventListener('keyup', e => { if (e.key === 'Enter') sendChatBtn.click(); });

        function handlePlaybackChange(playback) {
            if (!isYouTubeApiReady || !playback) return;
            lastKnownPlaybackState = playback;
            const { videoId } = playback;
            if (!videoId) {
                playerPlaceholder.textContent = "Aguardando mÃºsica...";
                playerPlaceholder.style.display = 'flex';
                if (player) { player.destroy(); player = null; }
                return;
            }
            playerPlaceholder.style.display = 'none';
            if (!player) {
                player = new YT.Player('player', {
                    height: '100%', width: '100%', videoId,
                    playerVars: { 'playsinline': 1, 'autoplay': 0, 'controls': isDj ? 1 : 0, 'disablekb': 1, 'modestbranding': 1, 'rel': isDj ? 1 : 0 },
                    events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
                });
            } else {
                if (player.getVideoData().video_id !== videoId) player.loadVideoById(videoId);
                else syncPlayerState(playback);
            }
        }

        function onPlayerReady(event) {
            syncPlayerState(lastKnownPlaybackState);
            if (isDj) {
                syncInterval = setInterval(() => {
                    if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
                        database.ref(`rooms/${currentRoomKey}/playback`).update({
                            videoTime: player.getCurrentTime(),
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                }, 3000);
            }
        }

        function onPlayerStateChange(event) {
            if (!isDj) return;
            const playbackRef = database.ref(`rooms/${currentRoomKey}/playback`);
            const currentTime = player.getCurrentTime();
            if (event.data === YT.PlayerState.PLAYING) playbackRef.update({ isPlaying: true, videoTime: currentTime, timestamp: firebase.database.ServerValue.TIMESTAMP });
            else if (event.data === YT.PlayerState.PAUSED) playbackRef.update({ isPlaying: false, videoTime: currentTime });
            else if (event.data === YT.PlayerState.ENDED) playNextInQueue();
        }

        function playNextInQueue() {
            if (!isDj) return;
            const queueRef = database.ref(`rooms/${currentRoomKey}/queue`).orderByKey().limitToFirst(1);
            queueRef.once('value', s => {
                if (s.exists()) {
                    const [key, nextSong] = Object.entries(s.val())[0];
                    database.ref(`rooms/${currentRoomKey}/playback`).set({
                        videoId: nextSong.videoId, title: nextSong.title, isPlaying: true,
                        videoTime: 0, timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    database.ref(`rooms/${currentRoomKey}/queue/${key}`).remove();
                } else {
                    database.ref(`rooms/${currentRoomKey}/playback`).update({ videoId: null, isPlaying: false });
                    playerPlaceholder.textContent = "Fila vazia! DJ, adicione mÃºsicas ou aceite pedidos.";
                    playerPlaceholder.style.display = 'flex';
                    showToast("Fila de mÃºsicas terminou.");
                }
            });
        }

        function syncPlayerState(playback) {
            if (!player || !playback || !playback.videoId) return;
            const { isPlaying, videoTime, timestamp } = playback;
            let targetTime = videoTime;
            if (isPlaying) {
                targetTime = videoTime + (getServerTime() - timestamp) / 1000.0;
            }
            if (Math.abs(player.getCurrentTime() - targetTime) > 1.5) {
                player.seekTo(targetTime, true);
            }
            if (isPlaying && player.getPlayerState() !== YT.PlayerState.PLAYING) player.playVideo();
            else if (!isPlaying && player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo();
        }
    </script>
</body>
</html>
